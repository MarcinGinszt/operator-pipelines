---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: submission-validation
spec:
  params:
    - name: git_username
    - name: git_pr_title
    - name: pyxis_url
      default: https://catalog.redhat.com/api/containers
  results:
    - name: cert_project_id
    - name: operator_name
    - name: bundle_version
  workspaces:
    - name: source
  steps:
    - name: get-cert-project-id
      image: registry.access.redhat.com/ubi8-minimal
      script: |
        #! /usr/bin/env bash
        # cat ci.yaml | yq e '.cert_project_id' - | tee $(results.cert_project_id.path)
        echo "1234abcd" | tee $(results.cert_project_id.path)

    - name: verify-user-submiting
      image: registry.access.redhat.com/ubi8-minimal
      script: |
        #! /usr/bin/env bash
        # Python script
        echo "ok"

    - name: verify-pr
      workingDir: $(workspaces.source.path)
      # here we'll use custom image with Python script
      image: registry.access.redhat.com/ubi8-minimal
      script: |
        #! /usr/bin/env bash

        # 1. Verify via regex if PR title follows convention
        # 2. TODO: Verify, if the user which created the PR is allowed to
        # submit the operator
        # 3. Verify that there is no other open PRs for this operator

        verify-submission \
          --pr-title="operator other-cogito-operator (1.6.0-ok)" \
          --available-repositories=operator-pipelines-test \
          --pr-url=https://github.com/redhat-openshift-ecosystem/operator-pipelines-test/pull/5


        echo -n "kogito-operator" | tee $(results.operator_name.path)
        echo -n "1.6.1-ok" | tee $(results.bundle_version.path)
        echo "ok"
